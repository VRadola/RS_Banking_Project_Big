worker_processes  1;

events { worker_connections  1024; }

http {
  include       mime.types;
  default_type  application/octet-stream;
  sendfile      on;
  keepalive_timeout  65;

  upstream auth_upstream {
    least_conn;
    server auth_service_1:8000;
    server auth_service_2:8000;
  }

  upstream account_upstream {
    least_conn;
    server account_service_1:8000;
    server account_service_2:8000;
  }

  upstream transaction_upstream {
    least_conn;
    server transaction_service_1:8000;
    server transaction_service_2:8000;
  }

  upstream payment_upstream {
    least_conn;
    server payment_service_1:8000;
    server payment_service_2:8000;
  }

  server {
    listen 80;

    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Idempotency-Key" always;

    if ($request_method = OPTIONS) {
      return 204;
    }

    location /health {
      return 200 '{"status":"ok"}';
      add_header Content-Type application/json;
    }

    location /auth/ {
      proxy_pass http://auth_upstream/;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /accounts/ {
      proxy_pass http://account_upstream/;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /transactions/ {
      proxy_pass http://transaction_upstream/;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /payments/ {
      proxy_pass http://payment_upstream/;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
  }
}